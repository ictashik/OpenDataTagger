{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-primary">Tagging in Progress...</h1>

    <!-- Progress Bar -->
    <div class="progress mt-3">
        <div id="progress-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%;"></div>
    </div>
    <p id="progress-info" class="mt-2 text-muted">Starting tagging...</p>

    <!-- Live Logs -->
    <h3 class="mt-4 text-secondary">Live Logs</h3>
    <div id="logs" class="log-container border p-3 text-light bg-dark rounded">
        <p id="log-placeholder" class="text-muted">Waiting for logs...</p>
    </div>
</div>
<script>
    function checkProgress() {
        fetch('/tagging/progress/')
            .then(response => response.json())
            .then(data => {
                console.log("Progress API Response:", data); // Debugging

                if (data.error) {
                    document.getElementById('progress-info').innerHTML = data.error;
                    return;
                }

                let done = data.done;
                let total = data.total;
                let status = data.status;

                // Update Progress Bar
                let progressBar = document.getElementById('progress-bar');
                let percentage = (done / total) * 100;
                progressBar.style.width = percentage + "%";

                document.getElementById('progress-info').innerHTML = 
                    `Processed ${done} of ${total} rows... [${status}]`;

                // Ensure logs container exists
                let logContainer = document.getElementById('logs');
                let logPlaceholder = document.getElementById('log-placeholder');

                if (!logContainer) {
                    console.error("Logs container not found.");
                    return;
                }

                if (logPlaceholder) {
                    logPlaceholder.style.display = data.logs.length === 0 ? "block" : "none";
                }

                logContainer.innerHTML = ''; // Clear old logs

                data.logs.forEach(log => {
                    let logEntry = document.createElement('div');
                    logEntry.classList.add("log-entry", "p-2", "border-bottom", "border-secondary");
                    logEntry.innerHTML = `
                        <span class="text-warning font-weight-bold">Row ${log.row_index}, ${log.column}</span><br>
                        <span class="text-light"><strong>Prompt:</strong> ${log.prompt}</span><br>
                        <span class="text-success"><strong>Best Answer:</strong> ${log.best_answer}</span><br>
                        <span class="text-info"><em>Explanation:</em> ${log.explanation}</span>
                    `;
                    logContainer.appendChild(logEntry);
                });

                // Auto-scroll logs to bottom
                logContainer.scrollTop = logContainer.scrollHeight;

                // If finished, redirect to results
                if (status === "finished") {
                    console.log("Tagging completed. Redirecting to results...");
                    window.location.href = "/results/";
                } else {
                    setTimeout(checkProgress, 1000);
                }
            })
            .catch(err => {
                console.error("Error fetching progress:", err);
                setTimeout(checkProgress, 2000);
            });
    }

    // Start polling after page loads
    document.addEventListener("DOMContentLoaded", checkProgress);
</script>
{% endblock %}